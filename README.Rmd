---
output: github_document
always_allow_html: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(kableExtra)

mytable <- function(df){
  kable(df) %>%
  kable_styling(bootstrap_options = c("hover", "condensed", "responsive"),
                full_width = F,
                font_size = 12)}

set.seed(876)
```
## Gender proportions in NEJM

We collected data from all publications registered in pubmed, from the New England Journal of Medicine, from 1945 to 2020. (Raw data available at [01_data]())

We extracted the bibtex from each paper with a doi using the package [rcrossref](https://github.com/ropensci/rcrossref). We use the default setting since it has complete names for all authors. The code for this step can be found in [`02_r/extract_bib`]().

Once we had every paper with the specific bibtex information, we followed the next steps to clean the data: 

```{r}
library(tidyverse)
```

#### Steps to import the data:
```{r}

data_dir <- "01b_clean_data"

rda_files <- fs::dir_ls(data_dir, regexp = "\\.Rda$")

data <- rda_files %>% 
  map_dfr(rio::import)

data <- data %>% 
  distinct(PMID, .keep_all = TRUE)

data %>% 
  select(DOI, bib) %>% 
  sample_n(3) %>% 
  mytable()

```

#### Extract authors name in multiple columns 

```{r}
# Create an author variable from the bibtex
data <- data %>% mutate(
  author = str_extract(bib, "(author = \\{)(.)+"),
  author = str_remove(author, "author = \\{"),
  author = str_remove(author, "\\},")
)

## Separate authors into multiple columns
## Create as many rows as authors for each paper

split_into_multiple <- function(column, pattern = ", ", into_prefix){
  cols <- str_split_fixed(column, pattern, n = Inf)
  cols[which(cols == "")] <- NA
  cols <- as_tibble(cols)
  m <- dim(cols)[2]
  
  names(cols) <- paste(into_prefix, 1:m, sep = "_")
  return(cols)
}

data_authors <- data %>% 
  bind_cols(split_into_multiple(data$author, " and ", "author")) %>% 
  pivot_longer(
    cols = starts_with("author_"),
    names_to = "author_position",
    values_to = "author_name",
    names_prefix = "author_") %>% 
  drop_na(author_name)

# Some authors only have initials, these will be excluded

# Separate first and last name

data_authors <- data_authors %>% 
  mutate(author_clean = str_remove_all(author_name, "[:upper:][:punct:]"),
         author_clean = str_trim(author_clean, side = "both")) %>% 
  separate(author_clean, into = c("first_name", "last_name"), fill = "left")

data_filtered <- data_authors %>% 
  drop_na(first_name) 

data_filtered %>% 
filter(DOI == "10.1056/nejm194511152332004") %>% 
  select(author_position, author_name, first_name, last_name) %>% 
  mytable()
```

#### Find gender for each author

I use the [`gender` package](https://github.com/ropensci/gender), by Mullen, L. (2019). gender: Predict Gender from Names Using Historical Data. R package version 0.5.3, 
and the U.S. Social Security Administration baby names database.

```{r}
names <- data_filtered %>% count(first_name) %>% pull(first_name)

gender <- gender::gender(names, method = "ssa")

data_filtered <- data_filtered %>% 
  left_join(gender, by = c("first_name" = "name")) %>% 
  select(-starts_with("proportion"),
         -starts_with("year"))

data_filtered %>% 
  select(first_name, gender) %>% 
  group_by(gender) %>% 
  sample_n(3) %>% 
  mytable()
```

## Plot

Insight on the number of papers per year, and number of missing papers with missing DOI

```{r, echo = FALSE}
data_dir <- "01_data"

csv_files <- fs::dir_ls(data_dir)

data <- csv_files %>% 
  map_dfr(read_csv, .id = "source",
          col_types = cols(
            `Create Date` = col_character()))

data <- data %>% 
  distinct(PMID, .keep_all = TRUE)


## Count how many papers per year and how many missing doi per year

data %>% 
  count(`Publication Year`) %>% 
  ggplot(aes(`Publication Year`, n)) +
  geom_line() +
  theme_minimal()

data %>% 
  group_by(`Publication Year`) %>% 
  count(is.na(DOI)) %>% 
  ungroup() %>% 
  ggplot(aes(`Publication Year`, n, color = `is.na(DOI)`)) +
  geom_line() +
  theme_minimal()

```

## Gender proportion over time


```{r}
count_gender <- data_filtered %>% 
  group_by(`Publication Year`) %>% 
  count(gender) %>% 
  mutate(prop = round(100*n/sum(n), 2))

count_gender %>% 
  mutate(
    gender = ifelse(is.na(gender), "unknown", gender), 
    gender = str_to_title(gender)) %>% 
  ggplot(aes(`Publication Year`, prop, fill = gender)) +
  geom_col() +
  scale_fill_manual(values = c("#A8E6CE", "#DCEDC2", "#FFD3B5" )) +
  theme_minimal() +
  labs(
    title = "NEJM, author's gender proportion",
    y = "Proportion (%)%",
    fill = "Gender")

```

## First author´s gender proportion over time

```{r}
count_gender_first <- data_filtered %>% 
  filter(author_position == 1) %>% 
  group_by(`Publication Year`) %>% 
  count(gender) %>% 
  mutate(prop = round(100*n/sum(n), 2))

count_gender_first %>% 
  mutate(
    gender = ifelse(is.na(gender), "unknown", gender), 
    gender = str_to_title(gender)) %>% 
  ggplot(aes(`Publication Year`, prop, fill = gender)) +
  geom_col() +
  scale_fill_manual(values = c("#A8E6CE", "#DCEDC2", "#FFD3B5" )) +
  theme_minimal() +
  labs(
    title = "NEJM, first author's gender proportion",
    y = "Proportion (%)%",
    fill = "Gender")
```

## Single author´s proportion over time

```{r}
count_single <- data_filtered %>% 
  group_by(DOI) %>% 
  mutate(total_authors = last(author_position)) %>%
  ungroup() %>% 
  filter(total_authors == 1) %>% 
  group_by(`Publication Year`) %>% 
  count(gender) %>% 
  mutate(prop = round(100*n/sum(n), 2))

count_single %>% 
  mutate(
    gender = ifelse(is.na(gender), "unknown", gender), 
    gender = str_to_title(gender)) %>% 
  ggplot(aes(`Publication Year`, prop, fill = gender)) +
  geom_col() +
  scale_fill_manual(values = c("#A8E6CE", "#DCEDC2", "#FFD3B5" )) +
  theme_minimal() +
  labs(
    title = "NEJM, Single author's gender proportion",
    y = "Proportion (%)%",
    fill = "Gender")

```

## Last author's gender proportion 

```{r}
count_last<- data_filtered %>% 
  group_by(DOI) %>% 
  filter(author_position == last(author_position)) %>%
  ungroup() %>% 
  group_by(`Publication Year`) %>% 
  count(gender) %>% 
  mutate(prop = round(100*n/sum(n), 2))

count_last %>% 
  mutate(
    gender = ifelse(is.na(gender), "unknown", gender), 
    gender = str_to_title(gender)) %>% 
  ggplot(aes(`Publication Year`, prop, fill = gender)) +
  geom_col() +
  scale_fill_manual(values = c("#A8E6CE", "#DCEDC2", "#FFD3B5" )) +
  theme_minimal() +
  labs(
    title = "NEJM, Last author's gender proportion",
    y = "Proportion (%)%",
    fill = "Gender")
```

